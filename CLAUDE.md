# Centaur — Project Instructions

These rules are **invariants**. Do not remove, override, or regress them when adding new features.

## UI Invariants

- **Boot splash**: 1000ms "CENTAUR" wordmark splash plays on every page load and refresh (not session-gated)
- **Dark "machined precision" theme**: Subtractive lighting, Z-axis panel shadows, `--bg-desk` as deepest layer
- **Geist Sans + Geist Mono** typography everywhere (never system fonts)
- **Collapsible left sidebar** with CSS width transition
- **Zoom controls**: Floating HUD at bottom-center of DocumentViewer + Ctrl+Scroll on PDF container
- **PDF canvas**: `brightness(0.96)` filter, box-shadow, border (physical desk feel)
- **Segmented control tab bar** with sliding indicator (not plain text tabs)
- **Message arrive animation**: 200ms translateY + opacity on chat messages
- **3-state button presses**: rest → hover → pressed (mechanical feel)

## Frontend Architecture

- **Zustand stores** for all shared state (useDocStore, useViewerStore, useChatStore, useInspectStore, useStudioStore) — never useState waterfalls in page.tsx
- **SSE streaming** for chat responses (ghost bubble stepper, not sync fetch)
- **Doc-scoped queries** via context pill in chat input
- **Structured citations** with fine-grained bbox highlighting (not free-text `[N]` markers)
- **Multi-turn conversation**: Last 6 messages sent to backend

## Backend Architecture

- **Two-phase VLM pipeline**: Layout Analyzer (Glance) → Visual Extractor (Read)
- **Post-extraction validators over prompt rules** (deterministic > probabilistic)
- **Per-series granularity** for accounting_basis (not page-level)
- **Jinja2 SandboxedEnvironment** for template rendering (never raw Template)
- **SQL execution safety**: Semicolon guard + SELECT-only guard + READ ONLY transaction
- **Error sanitization**: Generic messages to clients, full traces to server logs
- **Alembic** manages Studio tables; legacy tables (document_ledger, metric_facts) on create_all()

## Audit Engine Invariants

- **6 deterministic validators** (StackedTotalCheck, CrossPageConsistencyCheck, YoYReasonabilityCheck, CurrencyMagnitudeCheck, NarrativeMetricCheck, PercentVerificationCheck) — zero LLM calls
- **audit_findings table** (Alembic-managed) stores all findings with severity, page, series, expected/actual values
- **Idempotent re-audit**: Delete old findings before re-running checks on a doc_hash
- **Runs after metric_facts insertion** at end of ingestion pipeline — <500ms per document
- **API**: `GET /api/v1/documents/{doc_hash}/audit` (read findings), `POST /api/v1/documents/{doc_hash}/audit/run` (force re-run)
- **Frontend**: Severity badge on document list (red/amber/green), Audit section in Inspect panel with finding cards

## Excel Export Invariants

- **openpyxl** for fine-grained control over hyperlinks, formatting, and column widths
- **=HYPERLINK() cells**: Every value cell links back to `{base_url}?doc={hash}&page={N}` for traceability
- **base_url** configurable via `CENTAUR_BASE_URL` env var (defaults to `http://localhost:3000`)
- **Pivot-ready format**: Frozen header row, auto-filter, accounting number format on resolved_value
- **Sheets**: Summary (doc metadata + audit count), Metrics (fact table), Series Index (unique series)
- **API**: `GET /api/v1/documents/{doc_hash}/export/excel` → `StreamingResponse` with `.xlsx`
- **Frontend**: Download button in document list + Metric Explorer; URL param handling (`?doc=X&page=Y`) for deep links

## NL Data Visualization Invariants

- **Vega-Lite v5** specs generated by LLM — declarative JSON, no imperative code generation
- **visualize node** is a terminal LangGraph node (skips generate_answer — the chart IS the answer)
- **Two LLM calls**: (1) Text-to-SQL for data retrieval, (2) Vega-Lite spec generation from results
- **SQL execution** reuses existing `analytics_driver.execute_sql()` with 3-layer safety guards
- **500-row data guard**: Auto-aggregate if SQL returns >500 rows before sending to frontend
- **Dark theme**: background `#111111`, text `#ededed`, grid `#333` — specified in spec prompt
- **SSE event type**: `viz` with payload `{spec, data, sql, title}` — distinct from `answer`/`citations`
- **Frontend**: `vega-embed` renders Vega-Lite specs in chat; fallback to raw table if spec fails
- **Router extension**: `route_query` detects "visualization" intent (chart, plot, graph, visualize, trend, compare...visually)

## Prompt Studio Invariants

- **MECE execution axes**: Context Source (documents|metrics_db|none) × Output Format (text|json|chart|table) — two independent dimensions, not 4 conflated modes
- **Valid combos**: 8 of 12; chart/table disabled when source ≠ metrics_db
- **Search strategy**: Multi-select [SEMANTIC|NUMERIC]; both = hybrid retrieval (merge + deduplicate by chunk_id)
- **TABLE bypasses LLM entirely** — returns raw SQL rows in ~50ms (no token cost)
- **2-step executor pipeline**: `_fetch_context()` → `_generate_output()` via ContextResult dataclass
- **Cache key includes search strategy**: `{prompt_id}:{doc_filter}:{sorted_strategies}` — prevents poisoning when toggling SEMANTIC↔NUMERIC
- **Context window guard**: SQL results limited to 50 rows for LLM markdown injection; full data preserved in ContextResult.sql_rows for chart/table
- **ContextResult carries raw_chunks**: Citation metadata preserved for audit trail (source_file, page_number)
- **Temperature persisted per-version**: Frozen into published snapshots for workflow determinism
- **Legacy API translator**: `@model_validator(mode="before")` converts old exec_mode payloads during transition period
- **Tools tab**: PROMPTS | WORKFLOWS | TOOLS — AgentTools expose prompts/workflows as reusable tools (MCP Phase 2)
- **Naming**: DOCUMENTS (not RAG), METRICS DB (not SQL), NONE (not Direct), JSON (not Structured), SEMANTIC/NUMERIC (not qualitative/quantitative)

## Document Manager Invariants

- **Separate `document_meta` table** — decoupled from `document_ledger` (ingestion state vs semantic metadata)
- **3-tier metadata extraction**: Deterministic (page_count, currency) → VLM-assisted (company_name, document_type, sector) at ~$0.01/doc
- **"Goldman Sachs trap" guard**: VLM prompt explicitly instructs company_name = subject entity, NOT the advisor/bank
- **`user_overrides` JSON field**: Tracks which fields were manually edited; VLM re-extraction skips overridden fields
- **`project_code`**: Virtual folder for deal teams — replaces traditional folder hierarchy
- **`as_of_date` vs `publish_date`**: Separate temporal fields (period end date vs document publish date)
- **Client-side fuzzy search**: `fuse.js` with weighted multi-field matching, 150ms debounce
- **Virtualized scrolling**: `@tanstack/react-virtual` for 60fps with 1000+ documents
- **2-line compressed cards**: company_name + type/period only (256px sidebar width is unforgiving)
- **Right Panel metadata inspector**: Form-based panel with AUTO/EDITED badges per field, not inline card expansion
- **Checkbox-on-hover** multi-select with Ctrl+Click, Shift+Click range select, floating batch action bar
- **Metadata panel**: PanelId = "meta" added to right panel system, requires selected document

## Design Philosophy

- No risk classification at ingestion — neutral fact record only
- series_nature/stated_direction = objective (capture at extraction); sentiment_direction = subjective (defer to downstream)
- Principled/mathematical fixes over arbitrary heuristics
